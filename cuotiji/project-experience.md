# 项目经验教训与错题集 (Project Mistakes & Lessons)

## 1. 文件持久化危机（2025-11-19）

- **错误描述**：
  - 在构建“小吏”角色的过程中，AI 过于依赖云端工具（`tool://role-creator`）或仅在对话上下文中生成内容，误以为只要在对话中确认了，知识就会自动保存到系统中。
  - 结果导致用户在文件列表中只看到前几章的内容，后续大量的分析感悟没有在本地硬盘生成物理文件，造成了“认知（AI认为有）与事实（硬盘上没有）”的严重偏差。

- **错误本质**：
  - **虚实不分**：混淆了“临时的对话上下文”与“永久的文件存储”。
  - **云端依赖陷阱**：误判了 PromptX 系统的机制，忽略了“本地优先”的原则。

- **正确解法（SOP）**：
  1.  **落袋为安**：任何重要的感悟、分析、代码修改，必须**立刻、显式地**调用 `write` 工具，将其写入本地硬盘的 `.md` 文件中。
  2.  **物理验证**：不要只信赖工具的返回结果，要以文件系统中是否存在该文件为最终标准。
  3.  **引用闭环**：创建新文件后，必须第一时间在角色主配置文件（如 `xiaoli.role.md`）中添加引用，确保知识被“正式收编”。

- **核心原则**：
  - **本地优先**：硬盘上的文件才是唯一的真理。
  - **即时固化**：分析完一章，记录一章，绝不拖延到最后批量处理。

## 2. PDF Reader 工具使用避坑指南（2025-11-21）

- **错误描述**：
  - 在调用 `tool://pdf-reader` 时，习惯性使用相对路径（如 `西游成事智慧...pdf`），导致工具报错 `ENOENT: no such file or directory`。
  - 甚至在参数传递时，有时会忽略参数名必须为 `pdfPath`（而非 `path`）。

- **错误本质**：
  - **路径上下文缺失**：工具执行环境的工作目录可能与用户感知的当前目录不一致，相对路径极易失效。
  - **参数精度不足**：未严格查阅工具手册（manual），凭直觉猜测参数名。

- **正确解法（SOP）**：
  1.  **绝对路径**：调用 `tool://pdf-reader` 时，`pdfPath` 参数必须使用**完整的绝对路径**（如 `/Users/du/Downloads/...`）。
  2.  **按需分页**：不要试图一次性读取整本书。先不传 `pages` 参数获取元数据（总页数），再通过 `pages: [start, end]` 数组按需读取特定章节，避免 Token 溢出。
  3.  **手册先行**：使用新工具前，务必先用 `mode: manual` 查看准确的参数定义。

- **核心原则**：
  - **路径绝对化**：给工具的路径，永远给绝对路径最稳妥。
  - **分而治之**：大文件读取，必分页处理。

## 3. 角色深度迁移实战复盘（2025-11-21）

- **挑战场景**：
  - 将一个在异地/旧设备上创建的角色（包含大量知识文件），完整迁移到新设备的 PromptX 本地客户端中。

- **错误尝试**：
  - **分批挤牙膏**：试图先迁移主文件，再慢慢迁移知识文件。这在 PromptX 的某些版本机制下，可能导致“写入一次后锁定”或状态不一致，无法后续追加。
  - **碎片化操作**：没有形成整体的文件清单，导致迁移丢三落四。

- **成功SOP（一次性深度迁移）**：
  1.  **全量读取**：先将源目录下的所有相关文件（`Role`, `Thought`, `Execution`, `Knowledge/*`）全部读取到内存中。
  2.  **批量写入**：使用 `tool://role-creator` 或批量文件写入工具，**一次性**将所有文件写入到目标位置。
  3.  **一鼓作气**：中间不要停顿，避免上下文丢失或系统状态锁定。
  4.  **最终验证**：写入完成后，立刻调用 `action` 激活角色，检查所有知识模块是否加载成功。

- **核心原则**：
  - **One-Shot（一次性）**：迁移这种事，要么不做，要么全做。
  - **整体性**：角色是一个有机体，主文件是骨架，知识文件是血肉，必须整体搬迁。
